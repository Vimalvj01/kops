# ---------------------------------------------------------------
#
# Private Network Topology in AWS
#
# Inspired by https://github.com/kubernetes/kops/issues/428
#
# This will handle deploying k8s instance into a private subnet.
#
# Where a private subnet means:
# A subnet doesn't have a route to the Internet gateway.
#
# Utility Subnet - A subnet that is used to bridge a private
# subnet to a public subnet with a NGW
#
# ---------------------------------------------------------------






# ---------------------------------------------------------------
# VPC
#
# This is a single VPC that will hold all networking componets for
# a k8s cluster
#
# ---------------------------------------------------------------
vpc/{{ ClusterName }}:
  id: {{ .NetworkID }}
  shared: {{ SharedVPC }}
  cidr: {{ .NetworkCIDR }}
  enableDnsSupport: true
  enableDnsHostnames: true

# ---------------------------------------------------------------
# DHCP
#
# If this is not a shared VPC
# (There is more than one availability zone for this cluster)
#
# Also add support for us-east-1
# ---------------------------------------------------------------
{{ if not SharedVPC }}
dhcpOptions/{{ ClusterName }}:
  domainNameServers: AmazonProvidedDNS
{{ if eq Region "us-east-1" }}
  domainName: ec2.internal
{{ else }}
  domainName: {{ Region }}.compute.internal
{{ end }}

vpcDHDCPOptionsAssociation/{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}
  dhcpOptions: dhcpOptions/{{ ClusterName }}
{{ end }}

# ---------------------------------------------------------------
# Internet Gateway
#
# This is the main entry point to the cluster. There will be a
# route table associated with the gateway.
# ---------------------------------------------------------------
internetGateway/{{ ClusterName }}:
  shared: {{ SharedVPC }}
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Main Route Table
#
# The main route table associated with the Internet Gateway
# ---------------------------------------------------------------
routeTable/main-{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Main Routes
#
# Routes for the Main Route Table
# ---------------------------------------------------------------
route/wan:
  routeTable: routeTable/main-{{ ClusterName }}
  cidr: 0.0.0.0/0
  internetGateway: internetGateway/{{ ClusterName }}
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Zones (Availability Zones)
#
# For every availability zone
#   - 1 Utility/Public subnet
#     - 1 NGW for the private subnet to NAT to
#     - 1 Route Table Association to the Main Route Table
#   - 1 Private subnet (to hold the instances)
# ---------------------------------------------------------------
{{ range $zone := .Zones }}

# ---------------------------------------------------------------
# Utility Subnet
#
# This is the public subnet that will hold the route to the
# gateway, the NAT gateway
# ---------------------------------------------------------------
subnet/utility-{{ $zone.Name }}.{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}
  availabilityZone: {{ $zone.Name }}
  cidr: {{ $zone.CIDR }}
  id: {{ $zone.ProviderID }}
  shared: {{ SharedZone $zone }}


{{ if not (SharedZone $zone) }}

# ---------------------------------------------------------------
# Utility Subnet Route Table Associations
#
# Map the Utility subnet to the Main route table
# ---------------------------------------------------------------
routeTableAssociation/main-{{ $zone.Name }}.{{ ClusterName }}:
  routeTable: routeTable/main-{{ ClusterName }}
  subnet: subnet/utility-{{ $zone.Name }}.{{ ClusterName }}

# ---------------------------------------------------------------
# Elastic IP
#
# Every NGW needs a public (Elastic) IP address, every private
# subnet needs a NGW, lets create it. We tie it to a subnet
# so we can track it in AWS
# ---------------------------------------------------------------
elasticIP/{{ $zone.Name }}.{{ ClusterName }}:
  subnet: subnet/utility-{{ $zone.Name }}.{{ ClusterName }}

# ---------------------------------------------------------------
# NAT Gateway
#
# All private subnets will need a NGW
#
# The instances in the private subnet can access the Internet by
# using a network address translation (NAT) gateway that resides
# in the public subnet.
# ---------------------------------------------------------------
ngw/{{ $zone.Name }}.{{ ClusterName }}:
  elasticIp: elasticIP/{{ $zone.Name }}.{{ ClusterName }}
  subnet: subnet/utility-{{ $zone.Name }}.{{ ClusterName }}

# ---------------------------------------------------------------
# Private Subnet
#
# This is the private subnet for each AZ
# ---------------------------------------------------------------
subnet/private-{{ $zone.Name }}.{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}
  availabilityZone: {{ $zone.Name }}
  cidr: {{ $zone.PrivateCIDR }}
  id: {{ $zone.ProviderID }}
  shared: {{ SharedZone $zone }}

# ---------------------------------------------------------------
# Private Route Table
#
# The private route table that will route to the NAT Gateway
# ---------------------------------------------------------------
routeTable/private-{{ $zone.Name }}.{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Private Subnet Route Table Associations
#
# Map the Private subnet to the Private route table
# ---------------------------------------------------------------
routeTableAssociation/private-{{ $zone.Name }}.{{ ClusterName }}:
  routeTable: routeTable/private-{{ $zone.Name }}.{{ ClusterName }}
  subnet: subnet/private-{{ $zone.Name }}.{{ ClusterName }}

# ---------------------------------------------------------------
# Private Routes
#
# Routes for the private route table.
# Will route to the NAT Gateway
# ---------------------------------------------------------------
route/private-{{ $zone.Name }}.{{ ClusterName }}:
  routeTable: routeTable/private-{{ $zone.Name }}.{{ ClusterName }}
  cidr: 0.0.0.0/0
  vpc: vpc/{{ ClusterName }}
  natGateway: ngw/{{ $zone.Name }}.{{ ClusterName }}


{{ end }}

{{ end }}




