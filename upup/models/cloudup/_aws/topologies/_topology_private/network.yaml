# ---------------------------------------------------------------
#
# Private Network Topology in AWS
#
# Inspired by https://github.com/kubernetes/kops/issues/428
#
# This will handle deploying k8s instance into a private subnet.
#
# Where a private subnet means:
# A subnet doesn't have a route to the Internet gateway.
#
# Utility Subnet - A subnet that is used to bridge a private
# subnet to a public subnet with a NGW
#
# ---------------------------------------------------------------









# ---------------------------------------------------------------
# VPC
#
# This is a single VPC that will hold all networking componets for
# a k8s cluster
#
# ---------------------------------------------------------------
vpc/{{ ClusterName }}:
  id: {{ .NetworkID }}
  shared: {{ SharedVPC }}
  cidr: {{ .NetworkCIDR }}
  enableDnsSupport: true
  enableDnsHostnames: true

# ---------------------------------------------------------------
# DHCP
#
# If this is not a shared VPC
# (There is more than one availability zone for this cluster)
#
# Also add support for us-east-1
# ---------------------------------------------------------------
{{ if not SharedVPC }}
dhcpOptions/{{ ClusterName }}:
  domainNameServers: AmazonProvidedDNS
{{ if eq Region "us-east-1" }}
  domainName: ec2.internal
{{ else }}
  domainName: {{ Region }}.compute.internal
{{ end }}

vpcDHDCPOptionsAssociation/{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}
  dhcpOptions: dhcpOptions/{{ ClusterName }}
{{ end }}

# ---------------------------------------------------------------
# Internet Gateway
#
# This is the main entry point to the cluster. There will be a
# route table associated with the gateway.
# ---------------------------------------------------------------
internetGateway/{{ ClusterName }}:
  shared: {{ SharedVPC }}
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Main Route Table
#
# The main route table associated with the Internet Gateway
# ---------------------------------------------------------------
routeTable/{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Routes
#
# Routes for the Main Route Table
# ---------------------------------------------------------------
route/0.0.0.0/0:
  routeTable: routeTable/{{ ClusterName }}
  cidr: 0.0.0.0/0
  internetGateway: internetGateway/{{ ClusterName }}
  vpc: vpc/{{ ClusterName }}

# ---------------------------------------------------------------
# Zones (Availability Zones)
#
# For every availability zone
#   - 1 Utility/Public subnet
#     - 1 NGW for the private subnet to NAT to
#     - 1 Route Table Association to the Main Route Table
#   - 1 Private subnet (to hold the instances)
# ---------------------------------------------------------------
{{ range $zone := .Zones }}

subnet/{{ $zone.Name }}.{{ ClusterName }}:
  vpc: vpc/{{ ClusterName }}
  availabilityZone: {{ $zone.Name }}
  cidr: {{ $zone.CIDR }}
  id: {{ $zone.ProviderID }}
  shared: {{ SharedZone $zone }}

# ---------------------------------------------------------------
# Utility Subnet Route Table Associations
#
# This is a core component of private networking for kubernetes
# on AWS. In order for a subnet to be considered private it can
# NOT have a route directly to the Internet Gateway. So all
# associations here must be for Utility Subnets only!
# ---------------------------------------------------------------
{{ if not (SharedZone $zone) }}
routeTableAssociation/{{ $zone.Name }}.{{ ClusterName }}:
  routeTable: routeTable/{{ ClusterName }}
  subnet: subnet/{{ $zone.Name }}.{{ ClusterName }}

# ---------------------------------------------------------------
# Elastic IP
#
# Every NGW needs a public (Elastic) IP address, every private
# subnet needs a NGW, lets create it
# ---------------------------------------------------------------
elasticIP/{{ $zone.Name }}.{{ ClusterName }}:
  associatedSubnetTag: subnet/{{ $zone.Name }}.{{ ClusterName }}

# ---------------------------------------------------------------
# NGW
#
# All private subnets will need a NGW
#
# The instances in the private subnet can access the Internet by
# using a network address translation (NAT) gateway that resides
# in the public subnet.
# ---------------------------------------------------------------
ngw/{{ $zone.Name }}.{{ ClusterName }}:
  elasticIp: elasticIP/{{ $zone.Name }}.{{ ClusterName }}
  subnet: subnet/{{ $zone.Name }}.{{ ClusterName }}


{{ end }}

{{ end }}




